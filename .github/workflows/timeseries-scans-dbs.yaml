#
# Apache v2 license
# Copyright (C) 2025 Intel Corporation
# SPDX-License-Identifier: Apache-2.0
#
name: "[Time SeriesAnalytics] Docker Bench Security Scan"
run-name: "[Time Series Analytics] Docker Bench Security Scan workflow (by @${{ github.actor }} via ${{ github.event_name }})"
permissions: read-all

on:
  workflow_dispatch:
  
jobs:
  DBS_job:
    runs-on: ubuntu-latest
    
    steps:
      - name: check the system
        run: |
          docker ps &&
          uname -a &&
          docker version && 
          git version && 
          docker compose version
      - name: Runner workspace path
        run: |
           echo "Cleaning up previous run"
           if [ -n "$(docker ps -aq)" ]; then
               docker stop $(docker ps -aq)
           fi
           if [ -n "$(docker ps -aq)" ]; then
               docker rm $(docker ps -aq)
           fi
           docker images --quiet --filter=dangling=true | xargs --no-run-if-empty docker rmi -f
           echo $PASSWORD | sudo -SE rm -rf "${{ github.workspace }}"

      - uses: actions/checkout@v1
        with:
            persist-credentials: false 
      - name: Build 
        run: |
          cd microservices/time-series-analytics/docker
          sed -i -e "s|TIME_SERIES_ANALYTICS_IMAGE=.*|TIME_SERIES_ANALYTICS_IMAGE=ia-time-series-analytics-microservice:latest|g" .env
          docker compose build
      - name: Deploy Time Series Analytics microservice
        run: |
          cd microservices/time-series-analytics/docker
          docker compose up -d
      - name: DBS download and scan for Time Series Analytics microservice
        run: |
          cd microservices/time-series-analytics/docker
          docker pull docker/docker-bench-security
          docker run -i --net host --pid host --cap-add audit_control \
            -v /var/lib:/var/lib \
            -v /var/run/docker.sock:/var/run/docker.sock \
            -v /usr/lib/systemd:/usr/lib/systemd \
            -v /etc:/etc \
            --label docker_bench_security \
            docker/docker-bench-security > dbs_scan_timeseries.txt
      - name: Undeploy
        run: |
          cd microservices/time-series-analytics/docker
          docker compose down -v
      - name: Upload Scan artifact to Github
        uses: actions/upload-artifact@v4
        with:
          name: DBS_time-series-analytics
          path: microservices/time-series-analytics/docker/dbs_scan_timeseries.txt

                  